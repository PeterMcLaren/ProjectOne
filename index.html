<!DOCTYPE html>
<html>
<style> 
 html, body { 
 width: 100%; 
 height: 100%; 
 margin: 0px;
 overflow: hidden; 
 } 
 </style>
<body>

<canvas tabindex='1' id="myCanvas" width="10" height="10" style="border:0px solid #000000;">
Your browser does not support the HTML5 canvas tag.
</canvas>

<script src="/socket.io/socket.io.js"></script>

<script>
 window.addEventListener('resize', resizecanvas, false);

 var blocksize = 50;
 var blocktypes = 5;
 var blockfilepath = "./blkgfx.jpg";

 var xpos = 0;
 var ypos = 0;

 var socket = io();
 var isdown = false;
 var mousedownatX,mousedownatY;
 var draggedtoX,draggedtoY;
 var mylinewidth = 5;

 var imageObj = document.createElement("img");
 var Blockgfx = document.createElement("canvas");
 var Blockgfxctx = Blockgfx.getContext("2d");
 imageObj.src = blockfilepath;
 Blockgfxctx.canvas.width=blocksize*blocktypes;
 Blockgfxctx.canvas.height=blocksize;
 imageObj.addEventListener("load",onload,false);
 
 var c = document.getElementById("myCanvas");
 var ctx = c.getContext("2d");
 ctx.canvas.width  = window.innerWidth;
 ctx.canvas.height = window.innerHeight;
 var imgbuff = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);

 c.addEventListener("mousedown", doMouseDown, false);
 c.addEventListener("mousemove", doDrag, false);
 c.addEventListener("mouseup", doMouseUp, false);
 c.addEventListener("mousewheel", doMouseWheel, false);
 c.addEventListener("keydown",doKeyDown,true);

 var socket = io();
 
 ctx.fillStyle = "#990099";
 ctx.fillRect(0,window.innerHeight-48,window.innerWidth,window.innerHeight);

 var grid =[];
 for (var i = 0 ; i<100; i++) {
     grid[i] = []; //initialise the inner array
     for (var j = 0; j<100; j++) {
         grid[i][j] = (Math.random() *blocktypes | 0);
     }
 }

 socket.on('mouseup', function(msg){
        ctx.strokeStyle = "#000000";
        ctx.beginPath();
        ctx.arc(msg.x,msg.y,msg.size,0,2*Math.PI);
        ctx.stroke();
     });

 function doKeyDown(event) {
     if (event.key == "z") {
         for (lp=0;lp<blocksize;lp++) {
            imgbuff = ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
            ctx.putImageData(imgbuff,1,0,0,0,ctx.canvas.width-1,ctx.canvas.height);
         }
     }
     else if (event.key == "x") {
        imgbuff = ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
        ctx.putImageData(imgbuff,10,0,0,0,ctx.canvas.width-1,ctx.canvas.height);
     }
 }

 function doMouseWheel(event) {
    ctx.fillStyle = "#003300";
    ctx.fillRect(0,ctx.canvas.height-48,ctx.canvas.width,ctx.canvas.height);
    imgbuff = ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
    ctx.putImageData(imgbuff,1,0,0,0,ctx.canvas.width-1,ctx.canvas.height);
 }

 function doDrag(event) {
     if (isdown) {
    
         ctx.putImageData(imgbuff, mousedownatX-mylinewidth/2-1, mousedownatY-mylinewidth/2-1);
         draggedtoX = Math.max(event.pageX,mousedownatX)+mylinewidth/2;
         draggedtoY = Math.max(event.pageY,mousedownatY)+mylinewidth/2;
         imgbuff = ctx.getImageData(mousedownatX-mylinewidth/2-1, mousedownatY-mylinewidth/2-1, draggedtoX+mylinewidth+1, draggedtoY+mylinewidth+1);    
         ctx.strokeStyle = "#888888";
         ctx.lineWidth=mylinewidth;
         //ctx.strokeRect(mousedownatX+mylinewidth/2, mousedownatY+mylinewidth/2, draggedtoX-mousedownatX-mylinewidth-1, draggedtoY-mousedownatY-mylinewidth-1);
         ctx.beginPath();
         ctx.arc((mousedownatX+draggedtoX)/2,(mousedownatY+draggedtoY)/2,Math.min((draggedtoX-mousedownatX)/2,(draggedtoY-mousedownatY)/2),0,2*Math.PI);
         ctx.stroke();
     }
 }
 function doMouseDown(event) {     
	mousedownatX = event.pageX;
    mousedownatY = event.pageY;
    draggedtoX = mousedownatX;
    draggedtoY = mousedownatY;
    imgbuff = ctx.getImageData(mousedownatX-mylinewidth/2-1, mousedownatY-mylinewidth/2-1, 1, 1);
	isdown = true;
 }
 function doMouseUp(event) {
     isdown = false;
     ctx.putImageData(imgbuff, mousedownatX-mylinewidth/2-1, mousedownatY-mylinewidth/2-1);
     socket.emit('mouseup',{x: (mousedownatX+draggedtoX)/2, y: (mousedownatY+draggedtoY)/2, size: Math.min((draggedtoX-mousedownatX)/2,(draggedtoY-mousedownatY)/2),});
 }
 function onload(event)
 {
    Blockgfxctx.drawImage(imageObj,0,0); 
    resizecanvas(event);
 }
 function resizecanvas(event) {
     ctx.canvas.width  = window.innerWidth;
     ctx.canvas.height = window.innerHeight;
     maxx = xpos + ctx.canvas.width/blocksize;
     maxy = ypos + ctx.canvas.height/blocksize;

     for (var x = xpos; x < maxx; x++) {
         for (var y = ypos; y < maxy; y++) {
             ctx.putImageData(getblock(grid[x][y]),x*blocksize,y*blocksize);
         }
     }
    
     function getblock(blocknumber) {
     return Blockgfxctx.getImageData(blocknumber*blocksize,0,blocksize,blocksize)
 }
}

</script> 

</body>
</html>

